$ontext
Exploiting Flexibility in Coupled Electricity and Natural Gas Markets: A Price-Based Approach
Copyright (C) 2017 Christos Ordoudis

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
$offtext


Sets
g        Dispatchable generators  /g1*g5/
g1(g)    Dispatchable generators (Type 1 - Thermal non-gas units)  /g1*g2,g5/
g2(g)    Dispatchable generators (Type 2 - NGFPPs)  /g3*g4/
gw       Natural gas wells  /gw1*gw2/
w        Wind farms  /w1/
s        Wind power scenarios  /s1*s20/
t        Time horizon  /t1*t24/
n        Power system nodes  /n1*n14/
ed       Electricty demands  /ed1/
gd       Natural gas demands  /gd1/
;

Parameters
pmax(g)          Max production of generating Unit g     /g1  80, g2  110, g3  50, g4  100, g5 100/
pmin(g)          Min production of generating Unit g     /g1  0, g2  0, g3  0, g4  0, g5 0/
ResUp(g)         Max reserve capacity of up regulation   /g1  10, g2  0, g3  30, g4  25, g5 20/
ResDn(g)         Max reserve capacity of down regulation /g1  10, g2  0, g3  30, g4  25, g5 20/
C(g)             Production cost of generating Unit g    /g1  30, g2  10, g3  0, g4  0, g5 60/
Cu(g)            Upward reserve cost                     /g1  33, g2  0, g3  0, g4  0, g5 66/
Cd(g)            Upward reserve cost                     /g1  27, g2  0, g3  0, g4  0, g5 54/
HRb(g)           Efficiency                              /g1  0, g2  0, g3  0.2, g4  0.3, g5 0/
Gmin(gw)         Min production of Gas Well gw           /gw1  0, gw2 0/
Gmax(gw)         Max production of Gas Well gw           /gw1  150, gw2 100/
Gup(gw)          Max reserve capacity of up regulation   /gw1  50, gw2 20/
Gdn(gw)          Max reserve capacity of down regulation /gw1  50, gw2 20/
Cgas(gw)         Production cost of Gas Well gw          /gw1  120, gw2 160/
Cgas_u(gw)       Up regulation cost of Gas Well gw       /gw1  132, gw2 176/
Cgas_d(gw)       Down regulation cost of Gas Well gw     /gw1  108, gw2 144/
Eldemand(t)      El demand level
EldemandMax      Max El demand                           /430/
Gasdemand(t)     Gas demand level
GasdemandMax     Max Gas demand                          /60/
Pipe_Cap         Pipe capacity                           /100/
w_cap            Wind farm capacity                      /215/
Wexp             Wind power expection
Wind_Scen(s,t)   Wind power scenarios
pi(s)            Scenario probability
Xmax             Limit of natural gas price adjustment   /80/

M_Pmax1(g)       Big M for complementarities
M_Pmax2(g)       Big M for complementarities
M_Pmin1(g)       Big M for complementarities
M_Pmin2(g)       Big M for complementarities
M_Wmax1          Big M for complementarities
M_Wmax2          Big M for complementarities
M_Wmin1          Big M for complementarities
M_Wmin2          Big M for complementarities
M_PuUp1(g,s)     Big M for complementarities
M_PuUp2(g,s)     Big M for complementarities
M_PuDn1(g,s)     Big M for complementarities
M_PuDn2(g,s)     Big M for complementarities
M_PdUp1(g,s)     Big M for complementarities
M_PdUp2(g,s)     Big M for complementarities
M_PdDn1(g,s)     Big M for complementarities
M_PdDn2(g,s)     Big M for complementarities
M_LshMax1(s)     Big M for complementarities
M_LshMax2(s)     Big M for complementarities
M_LshMin1(s)     Big M for complementarities
M_LshMin2(s)     Big M for complementarities
M_WspillMax1(s)  Big M for complementarities
M_WspillMax2(s)  Big M for complementarities
M_WspillMin1(s)  Big M for complementarities
M_WspillMin2(s)  Big M for complementarities
M_PRmax1(g,s)    Big M for complementarities
M_PRmax2(g,s)    Big M for complementarities
M_PRmin1(g,s)    Big M for complementarities
M_PRmin2(g,s)    Big M for complementarities
M_Pmax1_2l(g)    Big M for complementarities
M_Pmax2_2l(g)    Big M for complementarities
M_Pmin1_2l(g)    Big M for complementarities
M_Pmin2_2l(g)    Big M for complementarities
M_Wmax1_2l       Big M for complementarities
M_Wmax2_2l       Big M for complementarities
M_Wmin1_2l       Big M for complementarities
M_Wmin2_2l       Big M for complementarities

M_Gmax1_2l(gw)   Big M for complementarities
M_Gmax2_2l(gw)   Big M for complementarities
M_Gmin1_2l(gw)   Big M for complementarities
M_Gmin2_2l(gw)   Big M for complementarities
M_GuUp1(gw,s)    Big M for complementarities
M_GuUp2(gw,s)    Big M for complementarities
M_GuDn1(gw,s)    Big M for complementarities
M_GuDn2(gw,s)    Big M for complementarities
M_GdUp1(gw,s)    Big M for complementarities
M_GdUp2(gw,s)    Big M for complementarities
M_GdDn1(gw,s)    Big M for complementarities
M_GdDn2(gw,s)    Big M for complementarities
M_GshMax1(s)     Big M for complementarities
M_GshMax2(s)     Big M for complementarities
M_GshMin1(s)     Big M for complementarities
M_GshMin2(s)     Big M for complementarities
M_GRmax1(gw,s)   Big M for complementarities
M_GRmax2(gw,s)   Big M for complementarities
M_GRmin1(gw,s)   Big M for complementarities
M_GRmin2(gw,s)   Big M for complementarities

M_NGA            Big M for complementarities
M_NGA_t(t)       Big M for complementarities
M_UpF            Big M for complementarities
M_DnF            Big M for complementarities

Price_El_DA      Electricty price in day-ahead
Price_Gas_DA     Natural gas price in day-ahead
Price_El_RT      Electricty price in real-time
Price_Gas_RT     Natural gas price in real-time

BigM             Value of BigM  /1200/
;

* Big M value assignment

M_Pmax1(g) = BigM;
M_Pmax2(g) = BigM;
M_Pmin1(g) = BigM;
M_Pmin2(g) = BigM;
M_Wmax1 = BigM;
M_Wmax2 = BigM;
M_Wmin1 = BigM;
M_Wmin2 = BigM;
M_PuUp1(g,s) = BigM;
M_PuUp2(g,s) = BigM;
M_PuDn1(g,s) = BigM;
M_PuDn2(g,s) = BigM;
M_PdUp1(g,s) = BigM;
M_PdUp2(g,s) = BigM;
M_PdDn1(g,s) = BigM;
M_PdDn2(g,s) = BigM;
M_LshMax1(s) = BigM;
M_LshMax2(s) = BigM;
M_LshMin1(s) = BigM;
M_LshMin2(s) = BigM;
M_WspillMax1(s) = BigM;
M_WspillMax2(s) = BigM;
M_WspillMin1(s) = BigM;
M_WspillMin2(s) = BigM;
M_PRmax1(g,s) = BigM;
M_PRmax2(g,s) = BigM;
M_PRmin1(g,s) = BigM;
M_PRmin2(g,s) = BigM;
M_Pmax1_2l(g) = BigM;
M_Pmax2_2l(g) = BigM;
M_Pmin1_2l(g) = BigM;
M_Pmin2_2l(g) = BigM;
M_Wmax1_2l = BigM;
M_Wmax2_2l = BigM;
M_Wmin1_2l = BigM;
M_Wmin2_2l = BigM;
M_Gmax1_2l(gw) = BigM;
M_Gmax2_2l(gw) = BigM;
M_Gmin1_2l(gw) = BigM;
M_Gmin2_2l(gw) = BigM;
M_GuUp1(gw,s) = BigM;
M_GuUp2(gw,s) = BigM;
M_GuDn1(gw,s) = BigM;
M_GuDn2(gw,s) = BigM;
M_GdUp1(gw,s) = BigM;
M_GdUp2(gw,s) = BigM;
M_GdDn1(gw,s) = BigM;
M_GdDn2(gw,s) = BigM;
M_GshMax1(s) = BigM;
M_GshMax2(s) = BigM;
M_GshMin1(s) = BigM;
M_GshMin2(s) = BigM;
M_GRmax1(gw,s) = BigM;
M_GRmax2(gw,s) = BigM;
M_GRmin1(gw,s) = BigM;
M_GRmin2(gw,s) = BigM;
M_NGA = BigM*10;
M_NGA_t(t) = BigM*10;
M_UpF(s,t) = BigM*10;
M_DnF(s,t) = BigM*10;

* Probabilities

loop(s,
pi(s) = 1 / card(s);
);

* Loading wind poer scenarios, electricity and natural gas demand

TABLE scenarios(t,s)
$ondelim
$include wind_scenarios_20.csv
$offdelim
;

Wind_Scen(s,t) = scenarios(t,s) * w_cap;
Wexp(t) = sum(s, pi(s) * Wind_Scen(s,t));

TABLE Eldemand_pu(ed,t)
$ondelim
$include el_demand.csv
$offdelim
;

Eldemand(t) = Eldemand_pu("ed1",t) * EldemandMax;

TABLE Gasdemand_pu(gd,t)
$ondelim
$include gas_demand.csv
$offdelim
;

Gasdemand(t) = Gasdemand_pu("gd1",t) * GasdemandMax;

Scalar
vLOL_El    Value of lost electrity load       /1200/
vLOL_Gas   Value of lost gas load            /1000/
vWSP       Value of wind spillage           /0/
;

Variables
cost                       Total expected cost ($)

*** El system ***

p_gen(g,t)                 Power output of generating unit g
Pu(g,s,t)                  Up regulation of generating unit g
Pd(g,s,t)                  Down regulation of generating unit g
p_w(t)                     Power output of wind farm w
Lsh(s,t)                   Electricity load shedding
Wspill(s,t)                Wind spillage

*** Gas system ***

gas(gw,t)                  Natural gas production of gas well gw
gas_u(gw,s,t)              Natural gas production of gas well gw for up regulation in real-time
gas_d(gw,s,t)              Natural gas production of gas well gw for down regulation in real-time
GasEldemand(g,t)           Natural gas demand from GFPP unit g
GasEldemand_real(g,s,t)    Natural gas demand from GFPP unit g in real-time
Gsh(s,t)                   Natural gas load shedding

*** Natural gas price adjustment***
x(t)                       Natural gas price adjustment

*** Duals ***
lambda, lambdaG, lambda_RT, lambdaG_RT
;

Positive Variables
muUp, muDn, rhoUp, rhoDn,
muUp_G, muDn_G,
muNGA, muNGA_t, muUpF, muDnF,
Pu, Pd, gas_u, gas_d
Lsh, Wspill, Gsh,
muUpR, muDnR, muUpPlus, muUpMinus, muDnPlus, muDnMinus,
muUpR_G, muDnR_G, muUpPlus_G, muUpMinus_G, muDnPlus_G, muDnMinus_G, muUpLsh_G, muDnLsh_G,
muUpWsp, muDnWsp, muUpLsh, muDnLsh,
muUpHat, muDnHat, rhoUpHat , rhoDnHat
;

Binary Variables
u_Pmax, u_Pmin, u_Wmax, u_Wmin,
u_Pmax_2l, u_Pmin_2l, u_Wmax_2l, u_Wmin_2l,
u_PuUp, u_PuDn, u_PdUp, u_PdDn,
u_LshMax, u_LshMin, u_WspillMax, u_WspillMin,
u_PRmax, u_PRmin
u_Gmax_2l, u_Gmin_2l,
u_GuUp, u_GuDn, u_GdUp, u_GdDn,
u_GshMax, u_GshMin,
u_GRmax, u_GRmin,
u_NGA, u_NGA_t,
u_UpF, u_DnF
;

Equations
ObjFunc, LshuMax, LshuMin, power_balance_RT, PRu, PRl, PuuMax, PuuMin, PduMax, PduMin, WindSpillageMax, WindSpillageMin, gas_balance, GasWellmin, GasWellmax, gas_balance_RT, GasWellmin_RT, GasWellmax_RT, GasWellup_RT, GasWelldn_RT, Def_El2Gas_real_RT,
Gshu, premiumUp, premiumDn, mingen, maxgen, maxwind, minwind, power_balance, Def_El2Gas, NGA_max, NGA_t,
fairness,
gas_flow_cap_max, gas_flow_cap_min,
LagPg1, LagPg2, LagW,
LagPuPlus1, LagPuMinus1, LagPuPlus2, LagPuMinus2, LagLsh, LagWsp,
LagG, LagGu, LagGd, LagGsh,
Comp_PuUp1, Comp_PuUp2, Comp_PuDn1, Comp_PuDn2, Comp_PdUp1, Comp_PdUp2, Comp_PdDn1, Comp_PdDn2,
Comp_Pmax1_2l, Comp_Pmax2_2l, Comp_Pmin1_2l, Comp_Pmin2_2l, Comp_Wmax1_2l, Comp_Wmax2_2l, Comp_Wmin1_2l, Comp_Wmin2_2l,
Comp_LshMax1, Comp_LshMax2, Comp_LshMin1, Comp_LshMin2, Comp_WspillMax1, Comp_WspillMax2, Comp_WspillMin1, Comp_WspillMin2, Comp_PRmax1, Comp_PRmax2, Comp_PRmin1, Comp_PRmin2,
Comp_GuUp1, Comp_GuUp2, Comp_GuDn1, Comp_GuDn2, Comp_GdUp1, Comp_GdUp2, Comp_GdDn1, Comp_GdDn2,
Comp_Gmax1_2l, Comp_Gmax2_2l, Comp_Gmin1_2l, Comp_Gmin2_2l,
Comp_GshMax1, Comp_GshMax2, Comp_GshMin1, Comp_GshMin2, Comp_GRmax1, Comp_GRmax2, Comp_GRmin1, Comp_GRmin2,
Comp_NGA1, Comp_NGA2, Comp_NGA1_t, Comp_NGA2_t, Comp_UpF1, Comp_UpF2, Comp_dnF1, Comp_DnF2
;

ObjFunc..                                  cost =E= sum(t, sum(g1, C(g1) * p_gen(g1,t)) + sum(gw, Cgas(gw) * gas(gw,t))
                                                    + sum(s, pi(s) * (sum(gw, Cgas_u(gw) * gas_u(gw,s,t) - Cgas_d(gw) * gas_d(gw,s,t))
                                                    + sum(g1, Cu(g1) * Pu(g1,s,t) - Cd(g1) * Pd(g1,s,t)) + vLOL_El * Lsh(s,t) + vLOL_Gas * Gsh(s,t) + vWSP * Wspill(s,t))));

*** Natural gas price adjustment ***

premiumUp(t)..                             x(t) =L= Xmax;

premiumDn(t)..                             x(t) =G= - Xmax;

fairness..                                 sum(t, sum(g1, C(g1) * P_gen(g1,t)) + sum(gw, (Cgas(gw)*gas(gw,t)) + muUp_G(gw,t)*Gmax(gw))) - sum(t, lambdaG(t) * Gasdemand(t)) - sum(t, lambda(t) * Eldemand(t) - sum(g, muUp(g,t) * Pmax(g)) - Wexp(t) * rhoUp(t)) - (24 * sum(gw, Gmax(gw)) - sum(t, Gasdemand(t))) * muNGA - sum(t, (Pipe_Cap-Gasdemand(t)) * muNGA_t(t))  =E= 0;

*** KKT of lower level problems ***

* Primal costraints - El DA

mingen(g,t)..                              P_gen(g,t) =G= Pmin(g);

maxgen(g,t)..                              P_gen(g,t) =L= Pmax(g);

maxwind(t)..                               p_w(t) =L= Wexp(t);

minwind(t)..                               p_w(t) =G= 0;

power_balance(t)..                         sum(g, p_gen(g,t)) + p_w(t) - Eldemand(t) =E= 0;

Def_El2Gas(g2,t)..                         GasEldemand(g2,t) =E=  HRb(g2) * p_gen(g2,t);

NGA_max..                                  sum(t, sum(g2, GasEldemand(g2,t))) =L= 24 * sum(gw, Gmax(gw)) - sum(t, Gasdemand(t));

NGA_t(t)..                                 sum(g2, GasEldemand(g2,t)) =L= (Pipe_Cap-Gasdemand(t));

* Stationarity conditions

LagPg1(g1,t)..                             C(g1) - lambda(t) - muDn(g1,t) + muUp(g1,t) =E= 0;

LagPg2(g2,t)..                             HRb(g2) * lambdaG(t) + HRb(g2) * x(t) - lambda(t) - muDn(g2,t) + muUp(g2,t) + HRb(g2) * muNGA +  HRb(g2) * muNGA_t(t) =E= 0;

LagW(t)..                                  - lambda(t) - rhoDn(t) + rhoUp(t) =E= 0;

* Primal costraints - Gas DA

gas_balance(t)..                            sum(gw, gas(gw,t)) - Gasdemand(t) - sum(g2, GasEldemand(g2,t)) =E= 0;

GasWellmin(gw,t)..                         gas(gw,t) =G= Gmin(gw);

GasWellmax(gw,t)..                         gas(gw,t) =L= Gmax(gw);

* Stationarity conditions

LagG(gw,t)..                               Cgas(gw) - lambdaG(t) - muDn_G(gw,t) + muUp_G(gw,t) =E= 0;

* Primal constraints - El RT

LshuMax(s,t)..                             Lsh(s,t) =L= Eldemand(t);

LshuMin(s,t)..                             Lsh(s,t) =G= 0;

power_balance_RT(s,t)..                    sum(g, Pu(g,s,t) - Pd(g,s,t)) + Lsh(s,t) + Wind_scen(s,t) - Wspill(s,t) - p_w(t)  =E= 0;

PRu(g,s,t)..                               P_gen(g,t) + Pu(g,s,t) =L= Pmax(g);

PRl(g,s,t)..                               P_gen(g,t) - Pd(g,s,t) =G= Pmin(g);

PuuMax(g,s,t)..                            Pu(g,s,t) =L= ResUp(g) ;

PuuMin(g,s,t)..                            Pu(g,s,t) =G= 0 ;

PduMax(g,s,t)..                            Pd(g,s,t) =L= ResDn(g) ;

PduMin(g,s,t)..                            Pd(g,s,t) =G= 0 ;

WindSpillageMax(s,t)..                     Wspill(s,t) =L= Wind_scen(s,t);

WindSpillageMin(s,t)..                     Wspill(s,t) =G= 0;

* Stationarity conditions

LagPuPlus1(g1,s,t)..                       Cu(g1) - lambda_RT(s,t) + muUpR(g1,s,t) + muUpPlus(g1,s,t) - muDnPlus(g1,s,t) =E= 0;

LagPuMinus1(g1,s,t)..                      - Cd(g1) + lambda_RT(s,t) + muDnR(g1,s,t) + muUpMinus(g1,s,t) - muDnMinus(g1,s,t) =E= 0;

LagPuPlus2(g2,s,t)..                       (HRb(g2) * ( lambdaG_RT(s,t) + x(t))) - lambda_RT(s,t) + muUpR(g2,s,t) + muUpPlus(g2,s,t) - muDnPlus(g2,s,t) + muUpF(s,t)=E= 0;

LagPuMinus2(g2,s,t)..                      - (HRb(g2) * ( lambdaG_RT(s,t) + x(t))) + lambda_RT(s,t) + muDnR(g2,s,t) + muUpMinus(g2,s,t) - muDnMinus(g2,s,t) + muDnF(s,t) =E= 0;

LagLsh(s,t)..                              vLOL_El - lambda_RT(s,t) + muUpLsh(s,t) - muDnLsh(s,t) =E= 0;

LagWsp(s,t)..                              vWSP + lambda_RT(s,t) + muUpWsp(s,t) - muDnWsp(s,t) =E= 0;

* Primal constraints - Gas RT

gas_balance_RT(s,t)..                      sum(gw, (gas_u(gw,s,t) - gas_d(gw,s,t))) - sum(g2, (GasEldemand_real(g2,s,t) - GasEldemand(g2,t))) + Gsh(s,t) =E= 0;

GasWellmin_RT(gw,s,t)..                    gas(gw,t) - gas_d(gw,s,t) =G= Gmin(gw);

GasWellmax_RT(gw,s,t)..                    gas(gw,t) + gas_u(gw,s,t) =L= Gmax(gw);

GasWellup_RT(gw,s,t)..                     gas_u(gw,s,t) =L= Gup(gw);

GasWelldn_RT(gw,s,t)..                     gas_d(gw,s,t) =L= Gdn(gw);

Def_El2Gas_real_RT(g2,s,t)..               GasEldemand_real(g2,s,t) =E=  HRb(g2) * (P_gen(g2,t) + Pu(g2,s,t) - Pd(g2,s,t));

Gshu(s,t)..                                Gsh(s,t) =L= Gasdemand(t);

gas_flow_cap_max(s,t)..                    sum(g2, GasEldemand_real(g2,s,t)) =L= (Pipe_Cap-Gasdemand(t));

gas_flow_cap_min(s,t)..                    sum(g2, GasEldemand_real(g2,s,t)) =G= 0;

* Stationarity conditions

LagGu(gw,s,t)..                            Cgas_u(gw) - lambdaG_RT(s,t) + muUpR_G(gw,s,t) + muUpPlus_G(gw,s,t) - muDnPlus_G(gw,s,t) =E= 0;

LagGd(gw,s,t)..                            - Cgas_d(gw) + lambdaG_RT(s,t) + muDnR_G(gw,s,t) + muUpMinus_G(gw,s,t) - muDnMinus_G(gw,s,t) =E= 0;

LagGsh(s,t)..                              vLOL_Gas - lambdaG_RT(s,t) + muUpLsh_G(s,t) - muDnLsh_G(s,t) =E= 0;

* Complementarity conditions

* GAS RT

Comp_GuUp1(gw,s,t)..                       Gup(gw) - gas_u(gw,s,t) =L= M_GuUp1(gw,s) * (1-u_GuUp(gw,s,t));
Comp_GuUp2(gw,s,t)..                       muUpPlus_G(gw,s,t) =L= M_GuUp2(gw,s) * u_GuUp(gw,s,t);

Comp_GuDn1(gw,s,t)..                       gas_u(gw,s,t) =L= M_GuDn1(gw,s) * (1-u_GuDn(gw,s,t));
Comp_GuDn2(gw,s,t)..                       muDnPlus_G(gw,s,t) =L= M_GuDn2(gw,s) * u_GuDn(gw,s,t);

Comp_GdUp1(gw,s,t)..                       Gdn(gw) - gas_d(gw,s,t) =L= M_GdUp1(gw,s) * (1-u_GdUp(gw,s,t));
Comp_GdUp2(gw,s,t)..                       muUpMinus_G(gw,s,t) =L= M_GdUp2(gw,s) * u_GdUp(gw,s,t);

Comp_GdDn1(gw,s,t)..                       gas_d(gw,s,t) =L= M_GdDn1(gw,s) * (1-u_GdDn(gw,s,t));
Comp_GdDn2(gw,s,t)..                       muDnMinus_G(gw,s,t) =L= M_GdDn2(gw,s) * u_GdDn(gw,s,t);

Comp_GshMax1(s,t)..                        Gasdemand(t) - Gsh(s,t) =L= M_GshMax1(s) * (1-u_GshMax(s,t));
Comp_GshMax2(s,t)..                        muUpLsh_G(s,t) =L= M_GshMax2(s) * u_GshMax(s,t);

Comp_GshMin1(s,t)..                        Gsh(s,t) =L= M_GshMin1(s) * (1-u_GshMin(s,t));
Comp_GshMin2(s,t)..                        muDnLsh_G(s,t) =L= M_GshMin2(s) * u_GshMin(s,t);

Comp_GRmax1(gw,s,t)..                      Gmax(gw)-gas(gw,t)-gas_u(gw,s,t) =L= M_GRmax1(gw,s) * (1-u_GRmax(gw,s,t));
Comp_GRmax2(gw,s,t)..                      muUpR_G(gw,s,t) =L= M_GRmax2(gw,s) * u_GRmax(gw,s,t);

Comp_GRmin1(gw,s,t)..                      gas(gw,t)-gas_d(gw,s,t)-Gmin(gw) =L= M_GRmin1(gw,s) * (1-u_GRmin(gw,s,t));
Comp_GRmin2(gw,s,t)..                      muDnR_G(gw,s,t) =L= M_GRmin2(gw,s) * u_GRmin(gw,s,t);

Comp_UpF1(s,t)..                           (Pipe_Cap-Gasdemand(t)) - sum(g2, GasEldemand_real(g2,s,t)) =L= M_UpF(s,t) * (1-u_UpF(s,t));
Comp_UpF2(s,t)..                           muUpF(s,t) =L= M_UpF(s,t) * u_UpF(s,t);

Comp_DnF1(s,t)..                           sum(g2, GasEldemand_real(g2,s,t)) =L= M_DnF(s,t) * (1-u_DnF(s,t));
Comp_DnF2(s,t)..                           muDnF(s,t) =L= M_DnF(s,t) * u_DnF(s,t);

* EL RT

Comp_PuUp1(g,s,t)..                        ResUp(g) - Pu(g,s,t) =L= M_PuUp1(g,s) * (1-u_PuUp(g,s,t));
Comp_PuUp2(g,s,t)..                        muUpPlus(g,s,t) =L= M_PuUp2(g,s) * u_PuUp(g,s,t);

Comp_PuDn1(g,s,t)..                        Pu(g,s,t) =L= M_PuDn1(g,s) * (1-u_PuDn(g,s,t));
Comp_PuDn2(g,s,t)..                        muDnPlus(g,s,t) =L= M_PuDn2(g,s) * u_PuDn(g,s,t);

Comp_PdUp1(g,s,t)..                        ResDn(g) - Pd(g,s,t) =L= M_PdUp1(g,s) * (1-u_PdUp(g,s,t));
Comp_PdUp2(g,s,t)..                        muUpMinus(g,s,t) =L= M_PdUp2(g,s) * u_PdUp(g,s,t);

Comp_PdDn1(g,s,t)..                        Pd(g,s,t) =L= M_PdDn1(g,s) * (1-u_PdDn(g,s,t));
Comp_PdDn2(g,s,t)..                        muDnMinus(g,s,t) =L= M_PdDn2(g,s) * u_PdDn(g,s,t);

Comp_LshMax1(s,t)..                        Eldemand(t) - Lsh(s,t) =L= M_LshMax1(s) * (1-u_LshMax(s,t));
Comp_LshMax2(s,t)..                        muUpLsh(s,t) =L= M_LshMax2(s) * u_LshMax(s,t);

Comp_LshMin1(s,t)..                        Lsh(s,t) =L= M_LshMin1(s) * (1-u_LshMin(s,t));
Comp_LshMin2(s,t)..                        muDnLsh(s,t) =L= M_LshMin2(s) * u_LshMin(s,t);

Comp_WspillMax1(s,t)..                     Wind_scen(s,t) - Wspill(s,t) =L= M_WspillMax1(s) * (1-u_WspillMax(s,t));
Comp_WspillMax2(s,t)..                     muUpWsp(s,t) =L= M_WspillMax2(s) * u_WspillMax(s,t);

Comp_WspillMin1(s,t)..                     Wspill(s,t) =L= M_WspillMin1(s) * (1-u_WspillMin(s,t));
Comp_WspillMin2(s,t)..                     muDnWsp(s,t) =L= M_WspillMin2(s) * u_WspillMin(s,t);

Comp_PRmax1(g,s,t)..                       Pmax(g)-P_gen(g,t)-Pu(g,s,t) =L= M_PRmax1(g,s) * (1-u_PRmax(g,s,t));
Comp_PRmax2(g,s,t)..                       muUpR(g,s,t) =L= M_PRmax2(g,s) * u_PRmax(g,s,t);

Comp_PRmin1(g,s,t)..                       P_gen(g,t)-Pd(g,s,t)-Pmin(g) =L= M_PRmin1(g,s) * (1-u_PRmin(g,s,t));
Comp_PRmin2(g,s,t)..                       muDnR(g,s,t) =L= M_PRmin2(g,s) * u_PRmin(g,s,t);

* GAS DA

Comp_Gmax1_2l(gw,t)..                      Gmax(gw)-gas(gw,t) =L= M_Gmax1_2l(gw) * (1-u_Gmax_2l(gw,t));
Comp_Gmax2_2l(gw,t)..                      muUp_G(gw,t) =L= M_Gmax2_2l(gw) * u_Gmax_2l(gw,t);

Comp_Gmin1_2l(gw,t)..                      gas(gw,t)-Gmin(gw) =L= M_Gmin1_2l(gw) * (1-u_Gmin_2l(gw,t));
Comp_Gmin2_2l(gw,t)..                      muDn_G(gw,t) =L= M_Gmin2_2l(gw) * u_Gmin_2l(gw,t);

* EL DA

Comp_Pmax1_2l(g,t)..                       Pmax(g)-P_gen(g,t) =L= M_Pmax1_2l(g) * (1-u_Pmax_2l(g,t));
Comp_Pmax2_2l(g,t)..                       muUp(g,t) =L= M_Pmax2_2l(g) * u_Pmax_2l(g,t);

Comp_Pmin1_2l(g,t)..                       P_gen(g,t)-Pmin(g) =L= M_Pmin1_2l(g) * (1-u_Pmin_2l(g,t));
Comp_Pmin2_2l(g,t)..                       muDn(g,t) =L= M_Pmin2_2l(g) * u_Pmin_2l(g,t);

Comp_Wmax1_2l(t)..                         Wexp(t)-p_w(t) =L= M_Wmax1_2l * (1-u_Wmax_2l(t));
Comp_Wmax2_2l(t)..                         rhoUp(t) =L= M_Wmax2_2l * u_Wmax_2l(t);

Comp_Wmin1_2l(t)..                         p_w(t) =L= M_Wmin1_2l * (1-u_Wmin_2l(t));
Comp_Wmin2_2l(t)..                         rhoDn(t) =L= M_Wmin2_2l * u_Wmin_2l(t);

Comp_NGA1..                                24 * sum(gw, Gmax(gw)) - sum(t, Gasdemand(t)) - sum(t, sum(g2, GasEldemand(g2,t))) =L=  M_NGA * (1-u_NGA);
Comp_NGA2..                                muNGA =L= M_NGA * u_NGA;

Comp_NGA1_t(t)..                           (Pipe_Cap-Gasdemand(t)) - sum(g2, GasEldemand(g2,t)) =L=  M_NGA_t(t) * (1-u_NGA_t(t));
Comp_NGA2_t(t)..                           muNGA_t(t) =L= M_NGA_t(t) * u_NGA_t(t);

Model GTSO /all/;

Option optca = 0;
Option optcr = 0;
Option limcol = 1000;
Option limrow = 1000;

Solve GTSO using MIP minimizing cost;

Parameter
Comp_check_Pmax_2l, Comp_check_Pmin_2l, Comp_check_Wmax_2l, Comp_check_Wmin_2l, Comp_check_Pmax, Comp_check_Pmin, Comp_check_Wmax, Comp_check_Wmin,
Comp_check_PuUp, Comp_check_PuDn, Comp_check_PdUp, Comp_check_PdDn, Comp_check_LshMax, Comp_check_LshMin, Comp_check_WspillMax, Comp_check_WspillMin, Comp_check_PRmax, Comp_check_PRmin,
Comp_check_Gmax_2l, Comp_check_Gmin_2l, Comp_check_GuUp, Comp_check_GuDn, Comp_check_GdUp, Comp_check_GdDn, Comp_check_GshMax, Comp_check_GshMin, Comp_check_GRmax, Comp_check_GRmin
Comp_check_NGA, Comp_check_NGA_t, Comp_check_UpF, Comp_check_DnF,
Total_sub_DA, Total_sub_Tot
;

* Checking if complementarity holds

Comp_check_Pmax_2l(g,t) =  (Pmax(g)-P_gen.l(g,t)) * muUp.l(g,t);
Comp_check_Pmin_2l(g,t) =  (P_gen.l(g,t)-Pmin(g)) * muDn.l(g,t);
Comp_check_Pmax(g,t) =  (Pmax(g)-P_gen.l(g,t)) * muUp.l(g,t);
Comp_check_Pmin(g,t) =  (P_gen.l(g,t)-Pmin(g)) * muDn.l(g,t);
Comp_check_Wmax_2l(t) =  (Wexp(t)-p_w.l(t)) * rhoUp.l(t);
Comp_check_Wmin_2l(t) =  p_w.l(t) * rhoDn.l(t);
Comp_check_PuUp(g,s,t) = (ResUp(g) - Pu.l(g,s,t)) * muUpPlus.l(g,s,t);
Comp_check_PuDn(g,s,t) =  Pu.l(g,s,t) * muDnPlus.l(g,s,t);
Comp_check_PdUp(g,s,t) = (ResDn(g) - Pd.l(g,s,t)) * muUpMinus.l(g,s,t);
Comp_check_PdDn(g,s,t) = Pd.l(g,s,t) * muDnMinus.l(g,s,t);
Comp_check_LshMax(s,t) = (Eldemand(t) - Lsh.l(s,t)) * muUpLsh.l(s,t);
Comp_check_LshMin(s,t) = Lsh.l(s,t) * muDnLsh.l(s,t);
Comp_check_WspillMax(s,t) = (Wind_scen(s,t) - Wspill.l(s,t)) * muUpWsp.l(s,t);
Comp_check_WspillMin(s,t) = Wspill.l(s,t) * muDnWsp.l(s,t);
Comp_check_PRmax(g,s,t) = (Pmax(g)-P_gen.l(g,t)-Pu.l(g,s,t)) * muUpR.l(g,s,t);
Comp_check_PRmin(g,s,t) = (P_gen.l(g,t)-Pd.l(g,s,t)) * muDnR.l(g,s,t);

Comp_check_Gmax_2l(gw,t) =  (Gmax(gw)-gas.l(gw,t)) * muUp_G.l(gw,t);
Comp_check_Gmin_2l(gw,t) =  (gas.l(gw,t)-Gmin(gw)) * muDn_G.l(gw,t);
Comp_check_GuUp(gw,s,t) = (Gup(gw) - gas_u.l(gw,s,t)) * muUpPlus_G.l(gw,s,t);
Comp_check_GuDn(gw,s,t) =  gas_u.l(gw,s,t) * muDnPlus_G.l(gw,s,t);
Comp_check_GdUp(gw,s,t) = (Gdn(gw) - gas_d.l(gw,s,t)) * muUpMinus_G.l(gw,s,t);
Comp_check_GdDn(gw,s,t) = gas_d.l(gw,s,t) * muDnMinus_G.l(gw,s,t);
Comp_check_GshMax(s,t) = (Gasdemand(t) - Gsh.l(s,t)) * muUpLsh_G.l(s,t);
Comp_check_GshMin(s,t) = Gsh.l(s,t) * muDnLsh_G.l(s,t);
Comp_check_GRmax(gw,s,t) = (Gmax(gw)-gas.l(gw,t)-gas_u.l(gw,s,t)) * muUpR_G.l(gw,s,t);
Comp_check_GRmin(gw,s,t) = (gas.l(gw,t)-gas_d.l(gw,s,t)-Gmin(gw)) * muDnR_G.l(gw,s,t);

Comp_check_NGA = (24 * sum(gw, Gmax(gw)) - sum(t, Gasdemand(t)) - sum(t, sum(g2, GasEldemand.l(g2,t)))) * muNGA.l;
Comp_check_NGA_t(t) =  ((Pipe_Cap-Gasdemand(t)) - sum(g2, GasEldemand.l(g2,t)) - sum(g2, GasEldemand.l(g2,t))) * muNGA_t.l(t);
Comp_check_UpF(s,t) = ((Pipe_Cap-Gasdemand(t)) - sum(g2, GasEldemand_real.l(g2,s,t))) * muUpF.l(s,t);
Comp_check_DnF(s,t) =  sum(g2, GasEldemand_real.l(g2,s,t)) * muDnF.l(s,t);

* Market prices

Price_El_DA(t) = lambda.l(t);
Price_Gas_DA(t) = lambdaG.l(t);
Price_El_RT(s,t) = lambda_RT.l(s,t);
Price_Gas_RT(s,t) = lambdaG_RT.l(s,t);

* Day-ahead and total payment/charge to adjust the natural gas price for power production

Total_sub_Tot = sum(t, sum(s, pi(s) * sum(g2, (P_gen.l(g2,t) + Pu.l(g2,s,t) - Pd.l(g2,s,t)) * (HRb(g2) * x.l(t)))));
Total_sub_DA = sum(t, sum(g2, (P_gen.l(g2,t)) * ( HRb(g2) * x.l(t))));

* Display results

Display cost.l, P_gen.l, p_w.l, Pu.l, Pd.l, Wspill.l, Lsh.l, gas.l, gas_u.l, gas_d.l, Gsh.l, GasEldemand.l, GasEldemand_real.l, x.l;
Display Comp_check_Pmax, Comp_check_Pmin, Comp_check_Pmax_2l, Comp_check_Pmin_2l, Comp_check_Wmax_2l, Comp_check_Wmin_2l;
Display Comp_check_PuUp, Comp_check_PuDn, Comp_check_PdUp, Comp_check_PdDn, Comp_check_LshMax, Comp_check_LshMin, Comp_check_WspillMax, Comp_check_WspillMin, Comp_check_PRmax, Comp_check_PRmin;
Display Comp_check_Gmax_2l, Comp_check_Gmin_2l, Comp_check_GuUp, Comp_check_GuDn, Comp_check_GdUp, Comp_check_GdDn, Comp_check_GshMax, Comp_check_GshMin, Comp_check_GRmax, Comp_check_GRmin  ;
Display Comp_check_NGA, Comp_check_NGA_t, Comp_check_UpF, Comp_check_DnF;
Display Price_El_DA, Price_El_RT, Price_Gas_DA, Price_Gas_RT;
Display Total_sub_Tot, Total_sub_DA;
